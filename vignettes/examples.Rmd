---
title: "Examples"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Examples}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

I provide two examples on how the ineqx can be employed to study inequality

- [Example 1: Tracking changes in within- and between-group inequality over time](#e1)
- [Example 2: Decomposition of the motherhood effect](#e2)

### Tracking changes in within- and between-group inequality over time {#e1}

The R file of this example can be found [here](https://benrosche.github.io/rmm/articles/examples_files/ineqx_e1.Rmd).

In this first example, I demonstrate how the ineqx package can be used (1) to split the inequality in an outcome between groups into within- and between-group components and (2) to track changes in the within- and between-group components over time.

First, I load a reduced version of the Current Population Survey (CPS) containing a subsample of all women in CPS with information on their motherhood status and earnings between 1982 and 2022.

```{r, message = FALSE, warning = FALSE}
library(ineqx)

data("cps_sample")
```

In this dataset, women are grouped into low, medium, and high economic position by the total annual income of the household they lead or belong. They cutoff points are the 20 and 80 percentiles in each year.

Let us now calculate how much inequality there is within and between those groups:

```{r}
dat.wibe <- wibe(y="earnweekf", group = "SES", time = "i.year", weights = "earnwtf", long=T, dat=cps_sample)
```

The `wibe()` function takes the information on outcome (y), grouping structure (group), and time variable (time) to calculate within-group, between-group, and total inequality in each year. It returns two dataframes. The first dataframe contains the number of observations, the mean and variance of the outcome for each group and each year. The second dataframe returns the resulting within-group, between-group, and total inequality. 

Let us first plot the mean and variance of women's earnings by economic position over time:

```{r}
ggplot(data=
         dat.wibe[[1]] %>% 
         dplyr::filter(variable %in% c("mu", "sigma2")), 
       aes(x=year, y=value, color=factor(SES, labels = c("low", "medium", "high")))
       ) +
  facet_wrap(.~ variable, scales = "free_y") +
  geom_line(size=1.1) + 
  scale_x_continuous(limits = c(1980, 2020)) +
  labs(x="", y="Mean and variance of women's earnings", color="Total household income") +
  theme(legend.position = "bottom")
```

The ensuing development of within and between-group inequality over time:

```{r}
ggplot(data=
         dat.wibe[[2]] %>% 
         dplyr::filter(variable %in% c("CV2W", "CV2B", "CV2T")), 
       aes(x=year, y=value, color=factor(variable))
       ) +
  geom_line(size=1.1) + 
  scale_x_continuous(limits = c(1980, 2020)) +
  labs(x="", y="CV2", subtitle = "Earnings inequality among women in low-, medium-, and high-income households", color="Total household income") +
  theme(legend.position = "bottom")
```

Instead of the variance, I ask for the squared coefficient of variation as measure of inequality ($CV^{2}=\sigma^{2}/\mu^{2}$), which equals the variance divided by the squared mean. This is preferable when decomposing variation into within- and between-group components to not have the group with the highest income dominate the decomposition.

We can see that women in low-, medium-, and high-income households differ much more within each group than between. For men, it is the other way around (not shown).

Finally, let us analyze the degree to which inequality has been changing due to

- changes in within-group inequality
- changes in between-group inequality
- changes in the composition of groups

```{r}
dat.ineqx <- ineqx(y="earnweekf", ystat="CV2", group = "SES", time = "i.year", ref=1982, weights= "earnwtf", dat = cps_sample)

plot(dat.ineqx, type = "dT", yint = 2) + 
  geom_hline(yintercept=100, color="red") + 
  scale_y_continuous(breaks=seq(80,140,5)) +
  labs(y="Change in CV2 in % of 1982 level") 
```

We can see that inequality in women's earnings increased by 35% between 1982 and 2022. 
We can also see that group-compositional changes only played a minor role in this change.
While between 1982 and 2008, increases in within- and between-group inequality contributed to overall inequality similarly, since 2008, the increase in within-group inequality is noticeably higher.

### Decomposition of the motherhood effect{#e2}

The R file of this example can be found [here](https://benrosche.github.io/rmm/articles/examples_files/ineqx_e2.Rmd).

Let us know find out how the changing impact of motherhood on women's earnings has contributed to this development.

TBC

```{r}
?ineqx
```
